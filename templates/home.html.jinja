{% extends "base.html.jinja" %}

{% block head %}
<link rel="stylesheet" href="/static/home.css">
{% endblock %}

{% block content %}
<main>
  {% for groupName, groupSnippets in snippets %}
    <div class="options-group">
      <div class="group-label" data-target="{{ groupName }}-list">
        {{ groupName }}
      </div>

      <div class="checkbox-list" id="{{ groupName }}-list">
        {% for snippet in groupSnippets %}
          <div class="checkbox-item">
            <input
              type="checkbox"
              id="{{ snippet.ID }}"
              value="{{ snippet.ID }}"
            >

            <label for="{{ snippet.ID }}">
              {{ snippet.Name }}
            </label>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}

  <div class="subtitle">
    <a href="{{ repository.Origin }}/tree/{{ repository.Commit }}" target="_blank" class="branch-info">
      <span class="branch-name" id="branchName">{{ repository.Branch }}@</span>
      <span class="branch-commit" id="branchCommit">{{ repository.Commit }}</span>
    </a>
  </div>
</main>

<div class="footer">
  <div class="footer-content">
    <div class="url-container" id="urlContainer">
      <div class="url-display" id="urlDisplay"></div>
      
      <svg class="copy-icon" id="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
      </svg>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script defer>
  const BASE_URL = document.location.origin;
  const UNIVERSE_SIZE = 4096;

  const groupLabels = document.querySelectorAll('.group-label');
  groupLabels.forEach(label => {
    label.addEventListener('click', () => {
      const targetId = label.getAttribute('data-target');
      const checkboxList = document.getElementById(targetId);
      
      label.classList.toggle('collapsed');
      checkboxList.classList.toggle('hidden');
    });
  });

  const urlDisplay = document.getElementById('urlDisplay');
  function updateUrl() {
    const selectedIds = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => parseInt(cb.value, 10));

    const slug = selectedIds.join(",") || "..."
    urlDisplay.textContent = `@import '${BASE_URL}/s/${slug}';`;
  }

  const checkboxes = document.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateUrl);
  });

  const copyIcon = document.getElementById('copyIcon');
  function copyToClipboard() {
    const url = urlDisplay.textContent;
    navigator.clipboard.writeText(url).then(() => {
      urlContainer.classList.add('copied');
      copyIcon.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>';
      
      setTimeout(() => {
        urlContainer.classList.remove('copied');
        copyIcon.innerHTML = '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>';
      }, 2000);
    });
  }

  const urlContainer = document.getElementById('urlContainer');
  urlContainer.addEventListener('click', copyToClipboard);

  updateUrl();
</script>
{%endblock%}